"use strict";(self.webpackChunkan_onchain_app_in_100_components=self.webpackChunkan_onchain_app_in_100_components||[]).push([[9304],{"./node_modules/@thirdweb-dev/sdk/dist/cleanCurrencyAddress-ded19cfe.browser.esm.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{c:()=>cleanCurrencyAddress});var _index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/@thirdweb-dev/sdk/dist/index-33cd3415.browser.esm.js"),_fetchCurrencyValue_32d08b05_browser_esm_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@thirdweb-dev/sdk/dist/fetchCurrencyValue-32d08b05.browser.esm.js");function cleanCurrencyAddress(currencyAddress){return(0,_fetchCurrencyValue_32d08b05_browser_esm_js__WEBPACK_IMPORTED_MODULE_0__.i)(currencyAddress)?_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.aV:currencyAddress}},"./node_modules/@thirdweb-dev/sdk/dist/contract-platform-fee-e756e68f.browser.esm.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{C:()=>ContractPlatformFee});var _transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/@thirdweb-dev/sdk/dist/transactions-72f9603c.browser.esm.js"),_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@thirdweb-dev/sdk/dist/index-33cd3415.browser.esm.js");class ContractPlatformFee{featureName=_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_0__.du.name;constructor(contractWrapper){this.contractWrapper=contractWrapper}async get(){const[platformFeeRecipient,platformFeeBps]=await this.contractWrapper.read("getPlatformFeeInfo",[]);return _index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_0__.bH.parseAsync({platform_fee_recipient:platformFeeRecipient,platform_fee_basis_points:platformFeeBps})}set=(0,_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.f)((async platformFeeInfo=>{const parsed=await _index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_0__.bH.parseAsync(platformFeeInfo);return _transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.T.fromContractWrapper({contractWrapper:this.contractWrapper,method:"setPlatformFeeInfo",args:[parsed.platform_fee_recipient,parsed.platform_fee_basis_points]})}))}},"./node_modules/@thirdweb-dev/sdk/dist/marketplace-e3129e2f.browser.esm.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{a:()=>isWinningBid,g:()=>getAllInBatches,h:()=>handleTokenApproval,i:()=>isTokenApprovedForTransfer,m:()=>mapOffer,v:()=>validateNewListingParam});var ethers__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@ethersproject/contracts/lib.esm/index.js"),ethers__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./node_modules/@ethersproject/bignumber/lib.esm/bignumber.js"),tiny_invariant__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./node_modules/tiny-invariant/dist/esm/tiny-invariant.js"),_QueryParams_32a56510_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/@thirdweb-dev/sdk/dist/QueryParams-32a56510.browser.esm.js"),_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/@thirdweb-dev/sdk/dist/index-33cd3415.browser.esm.js"),_fetchCurrencyValue_32d08b05_browser_esm_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./node_modules/@thirdweb-dev/sdk/dist/fetchCurrencyValue-32d08b05.browser.esm.js"),console=__webpack_require__("./node_modules/console-browserify/index.js");async function isTokenApprovedForTransfer(provider,transferrerContractAddress,assetContract,tokenId,owner){try{const ERC165Abi=(await __webpack_require__.e(4811).then(__webpack_require__.t.bind(__webpack_require__,"./node_modules/@thirdweb-dev/contracts-js/dist/abis/IERC165.json",19))).default,erc165=new ethers__WEBPACK_IMPORTED_MODULE_0__.NZ(assetContract,ERC165Abi,provider),[isERC721,isERC1155]=await Promise.all([erc165.supportsInterface(_QueryParams_32a56510_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.I),erc165.supportsInterface(_QueryParams_32a56510_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.a)]);if(isERC721){const ERC721Abi=(await Promise.resolve().then(__webpack_require__.t.bind(__webpack_require__,"./node_modules/@thirdweb-dev/contracts-js/dist/abis/IERC721.json",19))).default,asset=new ethers__WEBPACK_IMPORTED_MODULE_0__.NZ(assetContract,ERC721Abi,provider);if(await asset.isApprovedForAll(owner,transferrerContractAddress))return!0;let approvedAddress;try{approvedAddress=await asset.getApproved(tokenId)}catch(e){}return approvedAddress?.toLowerCase()===transferrerContractAddress.toLowerCase()}if(isERC1155){const ERC1155Abi=(await Promise.resolve().then(__webpack_require__.t.bind(__webpack_require__,"./node_modules/@thirdweb-dev/contracts-js/dist/abis/IERC1155.json",19))).default,asset=new ethers__WEBPACK_IMPORTED_MODULE_0__.NZ(assetContract,ERC1155Abi,provider);return await asset.isApprovedForAll(owner,transferrerContractAddress)}return console.error("Contract does not implement ERC 1155 or ERC 721."),!1}catch(err){return console.error("Failed to check if token is approved",err),!1}}async function handleTokenApproval(contractWrapper,marketplaceAddress,assetContract,tokenId,from){const ERC165Abi=(await __webpack_require__.e(4811).then(__webpack_require__.t.bind(__webpack_require__,"./node_modules/@thirdweb-dev/contracts-js/dist/abis/IERC165.json",19))).default,erc165=new _index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_2__.cs(contractWrapper.getSignerOrProvider(),assetContract,ERC165Abi,contractWrapper.options,contractWrapper.storage),[isERC721,isERC1155]=await Promise.all([erc165.read("supportsInterface",[_QueryParams_32a56510_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.I]),erc165.read("supportsInterface",[_QueryParams_32a56510_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.a])]);if(isERC721){const ERC721Abi=(await Promise.resolve().then(__webpack_require__.t.bind(__webpack_require__,"./node_modules/@thirdweb-dev/contracts-js/dist/abis/IERC721.json",19))).default,asset=new _index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_2__.cs(contractWrapper.getSignerOrProvider(),assetContract,ERC721Abi,contractWrapper.options,contractWrapper.storage);if(!await asset.read("isApprovedForAll",[from,marketplaceAddress])){(await asset.read("getApproved",[tokenId])).toLowerCase()===marketplaceAddress.toLowerCase()||await asset.sendTransaction("setApprovalForAll",[marketplaceAddress,!0])}}else{if(!isERC1155)throw Error("Contract must implement ERC 1155 or ERC 721.");{const ERC1155Abi=(await Promise.resolve().then(__webpack_require__.t.bind(__webpack_require__,"./node_modules/@thirdweb-dev/contracts-js/dist/abis/IERC1155.json",19))).default,asset=new _index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_2__.cs(contractWrapper.getSignerOrProvider(),assetContract,ERC1155Abi,contractWrapper.options,contractWrapper.storage);await asset.read("isApprovedForAll",[from,marketplaceAddress])||await asset.sendTransaction("setApprovalForAll",[marketplaceAddress,!0])}}}function validateNewListingParam(param){if((0,tiny_invariant__WEBPACK_IMPORTED_MODULE_3__.A)(void 0!==param.assetContractAddress&&null!==param.assetContractAddress,"Asset contract address is required"),(0,tiny_invariant__WEBPACK_IMPORTED_MODULE_3__.A)(void 0!==param.buyoutPricePerToken&&null!==param.buyoutPricePerToken,"Buyout price is required"),(0,tiny_invariant__WEBPACK_IMPORTED_MODULE_3__.A)(void 0!==param.listingDurationInSeconds&&null!==param.listingDurationInSeconds,"Listing duration is required"),(0,tiny_invariant__WEBPACK_IMPORTED_MODULE_3__.A)(void 0!==param.startTimestamp&&null!==param.startTimestamp,"Start time is required"),(0,tiny_invariant__WEBPACK_IMPORTED_MODULE_3__.A)(void 0!==param.tokenId&&null!==param.tokenId,"Token ID is required"),(0,tiny_invariant__WEBPACK_IMPORTED_MODULE_3__.A)(void 0!==param.quantity&&null!==param.quantity,"Quantity is required"),"NewAuctionListing"===param.type)(0,tiny_invariant__WEBPACK_IMPORTED_MODULE_3__.A)(void 0!==param.reservePricePerToken&&null!==param.reservePricePerToken,"Reserve price is required")}async function mapOffer(provider,listingId,offer){return{quantity:offer.quantityDesired,pricePerToken:offer.pricePerToken,currencyContractAddress:offer.currency,buyerAddress:offer.offeror,quantityDesired:offer.quantityWanted,currencyValue:await(0,_fetchCurrencyValue_32d08b05_browser_esm_js__WEBPACK_IMPORTED_MODULE_4__.a)(provider,offer.currency,offer.quantityWanted.mul(offer.pricePerToken)),listingId}}function isWinningBid(winningPrice,newBidPrice,bidBuffer){if(bidBuffer=ethers__WEBPACK_IMPORTED_MODULE_5__.gH.from(bidBuffer),winningPrice=ethers__WEBPACK_IMPORTED_MODULE_5__.gH.from(winningPrice),newBidPrice=ethers__WEBPACK_IMPORTED_MODULE_5__.gH.from(newBidPrice),winningPrice.eq(ethers__WEBPACK_IMPORTED_MODULE_5__.gH.from(0)))return!1;return newBidPrice.sub(winningPrice).mul(_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_2__.dE).div(winningPrice).gte(bidBuffer)}async function getAllInBatches(start,end,fn){const batches=[];for(;end-start>_QueryParams_32a56510_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.D;)batches.push(fn(start,start+_QueryParams_32a56510_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.D-1)),start+=_QueryParams_32a56510_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.D;return batches.push(fn(start,end-1)),await Promise.all(batches)}},"./node_modules/@thirdweb-dev/sdk/dist/marketplacev3-offers-ce1f096b.browser.esm.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{M:()=>MarketplaceV3DirectListings,a:()=>MarketplaceV3EnglishAuctions,b:()=>MarketplaceV3Offers});var ethers__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./node_modules/@ethersproject/bignumber/lib.esm/bignumber.js"),ethers__WEBPACK_IMPORTED_MODULE_14__=__webpack_require__("./node_modules/@ethersproject/contracts/lib.esm/index.js"),ethers__WEBPACK_IMPORTED_MODULE_15__=__webpack_require__("./node_modules/@ethersproject/constants/lib.esm/addresses.js"),ethers__WEBPACK_IMPORTED_MODULE_16__=__webpack_require__("./node_modules/@ethersproject/units/lib.esm/index.js"),tiny_invariant__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__("./node_modules/tiny-invariant/dist/esm/tiny-invariant.js"),_cleanCurrencyAddress_ded19cfe_browser_esm_js__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__("./node_modules/@thirdweb-dev/sdk/dist/cleanCurrencyAddress-ded19cfe.browser.esm.js"),_fetchCurrencyValue_32d08b05_browser_esm_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./node_modules/@thirdweb-dev/sdk/dist/fetchCurrencyValue-32d08b05.browser.esm.js"),_normalizePriceValue_9851c0eb_browser_esm_js__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__("./node_modules/@thirdweb-dev/sdk/dist/normalizePriceValue-9851c0eb.browser.esm.js"),_setErc20Allowance_7f76f677_browser_esm_js__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__("./node_modules/@thirdweb-dev/sdk/dist/setErc20Allowance-7f76f677.browser.esm.js"),_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/@thirdweb-dev/sdk/dist/index-33cd3415.browser.esm.js"),_marketplace_e3129e2f_browser_esm_js__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./node_modules/@thirdweb-dev/sdk/dist/marketplace-e3129e2f.browser.esm.js"),_QueryParams_32a56510_browser_esm_js__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__("./node_modules/@thirdweb-dev/sdk/dist/QueryParams-32a56510.browser.esm.js"),_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("./node_modules/@thirdweb-dev/sdk/dist/transactions-72f9603c.browser.esm.js"),_assertEnabled_d1700f0b_browser_esm_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/@thirdweb-dev/sdk/dist/assertEnabled-d1700f0b.browser.esm.js"),zod__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/zod/lib/index.mjs"),_contract_appuri_5c40af52_browser_esm_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./node_modules/@thirdweb-dev/sdk/dist/contract-appuri-5c40af52.browser.esm.js"),_contract_interceptor_d7b164a7_browser_esm_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./node_modules/@thirdweb-dev/sdk/dist/contract-interceptor-d7b164a7.browser.esm.js"),console=__webpack_require__("./node_modules/console-browserify/index.js");const DirectListingInputParamsSchema=(()=>zod__WEBPACK_IMPORTED_MODULE_0__.z.object({assetContractAddress:_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.b9,tokenId:_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.b6,quantity:_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.b6.default(1),currencyContractAddress:_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.b9.default(_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.aV),pricePerToken:_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.cw,startTimestamp:_assertEnabled_d1700f0b_browser_esm_js__WEBPACK_IMPORTED_MODULE_2__.R.default(new Date),endTimestamp:_assertEnabled_d1700f0b_browser_esm_js__WEBPACK_IMPORTED_MODULE_2__.E,isReservedListing:zod__WEBPACK_IMPORTED_MODULE_0__.z.boolean().default(!1)}))();let Status=function(Status){return Status[Status.UNSET=0]="UNSET",Status[Status.Created=1]="Created",Status[Status.Completed=2]="Completed",Status[Status.Cancelled=3]="Cancelled",Status[Status.Active=4]="Active",Status[Status.Expired=5]="Expired",Status}({});class MarketplaceV3DirectListings{featureName=_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.dA.name;constructor(contractWrapper,storage){this.contractWrapper=contractWrapper,this.storage=storage,this.events=new _contract_appuri_5c40af52_browser_esm_js__WEBPACK_IMPORTED_MODULE_3__.a(this.contractWrapper),this.encoder=new _fetchCurrencyValue_32d08b05_browser_esm_js__WEBPACK_IMPORTED_MODULE_4__.C(this.contractWrapper),this.interceptor=new _contract_interceptor_d7b164a7_browser_esm_js__WEBPACK_IMPORTED_MODULE_5__.C(this.contractWrapper),this.estimator=new _contract_appuri_5c40af52_browser_esm_js__WEBPACK_IMPORTED_MODULE_3__.G(this.contractWrapper)}getAddress(){return this.contractWrapper.address}async getTotalCount(){return await this.contractWrapper.read("totalListings",[])}async getAll(filter){const totalListings=await this.getTotalCount(),start=ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(filter?.start||0).toNumber(),end=totalListings.toNumber();if(0===end)throw new Error("No listings exist on the contract.");let rawListings=[];rawListings=(await(0,_marketplace_e3129e2f_browser_esm_js__WEBPACK_IMPORTED_MODULE_7__.g)(start,end,((startId,endId)=>this.contractWrapper.read("getAllListings",[startId,endId])))).flat();const filteredListings=await this.applyFilter(rawListings,filter);return await Promise.all(filteredListings.map((listing=>this.mapListing(listing))))}async getAllValid(filter){const totalListings=await this.getTotalCount(),start=ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(filter?.start||0).toNumber(),end=totalListings.toNumber();if(0===end)throw new Error("No listings exist on the contract.");let rawListings=[];rawListings=(await(0,_marketplace_e3129e2f_browser_esm_js__WEBPACK_IMPORTED_MODULE_7__.g)(start,end,((startId,endId)=>this.contractWrapper.read("getAllValidListings",[startId,endId])))).flat();const filteredListings=await this.applyFilter(rawListings,filter);return await Promise.all(filteredListings.map((listing=>this.mapListing(listing))))}async getListing(listingId){const listing=await this.contractWrapper.read("getListing",[listingId]);return await this.mapListing(listing)}async isBuyerApprovedForListing(listingId,buyer){if(!(await this.validateListing(ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(listingId))).isReservedListing)throw new Error(`Listing ${listingId} is not a reserved listing.`);return await this.contractWrapper.read("isBuyerApprovedForListing",[listingId,await(0,_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.aL)(buyer)])}async isCurrencyApprovedForListing(listingId,currency){return await this.validateListing(ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(listingId)),await this.contractWrapper.read("isCurrencyApprovedForListing",[listingId,await(0,_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.aL)(currency)])}async currencyPriceForListing(listingId,currencyContractAddress){const listing=await this.validateListing(ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(listingId)),resolvedCurrencyAddress=await(0,_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.aL)(currencyContractAddress);if(resolvedCurrencyAddress===listing.currencyContractAddress)return listing.pricePerToken;if(!await this.isCurrencyApprovedForListing(listingId,resolvedCurrencyAddress))throw new Error(`Currency ${resolvedCurrencyAddress} is not approved for Listing ${listingId}.`);return await this.contractWrapper.read("currencyPriceForListing",[listingId,resolvedCurrencyAddress])}createListing=(0,_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.f)((async listing=>{const parsedListing=await DirectListingInputParamsSchema.parseAsync(listing);await(0,_marketplace_e3129e2f_browser_esm_js__WEBPACK_IMPORTED_MODULE_7__.h)(this.contractWrapper,this.getAddress(),parsedListing.assetContractAddress,parsedListing.tokenId,await this.contractWrapper.getSignerAddress());const normalizedPricePerToken=await(0,_normalizePriceValue_9851c0eb_browser_esm_js__WEBPACK_IMPORTED_MODULE_9__.n)(this.contractWrapper.getProvider(),parsedListing.pricePerToken,parsedListing.currencyContractAddress),blockTime=(await this.contractWrapper.getProvider().getBlock("latest")).timestamp;parsedListing.startTimestamp.lt(blockTime)&&(parsedListing.startTimestamp=ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(blockTime));const tx=_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.T.fromContractWrapper({contractWrapper:this.contractWrapper,method:"createListing",args:[{assetContract:parsedListing.assetContractAddress,tokenId:parsedListing.tokenId,quantity:parsedListing.quantity,currency:(0,_cleanCurrencyAddress_ded19cfe_browser_esm_js__WEBPACK_IMPORTED_MODULE_10__.c)(parsedListing.currencyContractAddress),pricePerToken:normalizedPricePerToken,startTimestamp:parsedListing.startTimestamp,endTimestamp:parsedListing.endTimestamp,reserved:parsedListing.isReservedListing}],parse:receipt=>({id:this.contractWrapper.parseLogs("NewListing",receipt?.logs)[0].args.listingId,receipt})});return tx.setGasLimitMultiple(1.2),tx}));createListingsBatch=(0,_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.f)((async listings=>{const data=(await Promise.all(listings.map((listing=>this.createListing.prepare(listing))))).map((tx=>tx.encode())),tx=_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.T.fromContractWrapper({contractWrapper:this.contractWrapper,method:"multicall",args:[data],parse:receipt=>this.contractWrapper.parseLogs("NewListing",receipt?.logs).map((event=>({id:event.args.listingId,receipt})))});return tx.setGasLimitMultiple(1.2),tx}));updateListing=(0,_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.f)((async(listingId,listing)=>{const parsedListing=await DirectListingInputParamsSchema.parseAsync(listing);await(0,_marketplace_e3129e2f_browser_esm_js__WEBPACK_IMPORTED_MODULE_7__.h)(this.contractWrapper,this.getAddress(),parsedListing.assetContractAddress,parsedListing.tokenId,await this.contractWrapper.getSignerAddress());const normalizedPricePerToken=await(0,_normalizePriceValue_9851c0eb_browser_esm_js__WEBPACK_IMPORTED_MODULE_9__.n)(this.contractWrapper.getProvider(),parsedListing.pricePerToken,parsedListing.currencyContractAddress),tx=_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.T.fromContractWrapper({contractWrapper:this.contractWrapper,method:"updateListing",args:[listingId,{assetContract:parsedListing.assetContractAddress,tokenId:parsedListing.tokenId,quantity:parsedListing.quantity,currency:(0,_cleanCurrencyAddress_ded19cfe_browser_esm_js__WEBPACK_IMPORTED_MODULE_10__.c)(parsedListing.currencyContractAddress),pricePerToken:normalizedPricePerToken,startTimestamp:parsedListing.startTimestamp,endTimestamp:parsedListing.endTimestamp,reserved:parsedListing.isReservedListing}],parse:receipt=>({id:this.contractWrapper.parseLogs("UpdatedListing",receipt?.logs)[0].args.listingId,receipt})});return tx.setGasLimitMultiple(1.2),tx}));cancelListing=(0,_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.f)((async listingId=>{const tx=_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.T.fromContractWrapper({contractWrapper:this.contractWrapper,method:"cancelListing",args:[listingId]});return tx.setGasLimitMultiple(1.2),tx}));buyFromListing=(0,_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.f)((async(listingId,quantityDesired,receiver)=>{receiver&&(receiver=await(0,_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.aL)(receiver));const listing=await this.validateListing(ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(listingId)),{valid,error}=await this.isStillValidListing(listing,quantityDesired);if(!valid)throw new Error(`Listing ${listingId} is no longer valid. ${error}`);const buyFor=receiver||await this.contractWrapper.getSignerAddress(),quantity=ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(quantityDesired),value=ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(listing.pricePerToken).mul(quantity),overrides=await this.contractWrapper.getCallOverrides()||{};await(0,_setErc20Allowance_7f76f677_browser_esm_js__WEBPACK_IMPORTED_MODULE_11__.s)(this.contractWrapper,value,listing.currencyContractAddress,overrides);const tx=_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.T.fromContractWrapper({contractWrapper:this.contractWrapper,method:"buyFromListing",args:[listingId,buyFor,quantity,listing.currencyContractAddress,value],overrides});return tx.setGasLimitMultiple(1.2),tx}));approveBuyerForReservedListing=(0,_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.f)((async(listingId,buyer)=>{if(await this.isBuyerApprovedForListing(listingId,buyer))throw new Error(`Buyer ${buyer} already approved for listing ${listingId}.`);{const tx=_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.T.fromContractWrapper({contractWrapper:this.contractWrapper,method:"approveBuyerForListing",args:[listingId,buyer,!0]});return tx.setGasLimitMultiple(1.2),tx}}));revokeBuyerApprovalForReservedListing=(0,_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.f)((async(listingId,buyer)=>{if(await this.isBuyerApprovedForListing(listingId,buyer)){const tx=_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.T.fromContractWrapper({contractWrapper:this.contractWrapper,method:"approveBuyerForListing",args:[listingId,buyer,!1]});return tx.setGasLimitMultiple(1.2),tx}throw new Error(`Buyer ${buyer} not approved for listing ${listingId}.`)}));approveCurrencyForListing=(0,_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.f)((async(listingId,currencyContractAddress,pricePerTokenInCurrency)=>{const listing=await this.validateListing(ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(listingId)),resolvedCurrencyAddress=await(0,_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.aL)(currencyContractAddress);resolvedCurrencyAddress===listing.currencyContractAddress&&(0,tiny_invariant__WEBPACK_IMPORTED_MODULE_12__.A)(pricePerTokenInCurrency===listing.pricePerToken,"Approving listing currency with a different price.");const currencyPrice=await this.contractWrapper.read("currencyPriceForListing",[listingId,resolvedCurrencyAddress]);(0,tiny_invariant__WEBPACK_IMPORTED_MODULE_12__.A)(pricePerTokenInCurrency===currencyPrice,"Currency already approved with this price.");const tx=_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.T.fromContractWrapper({contractWrapper:this.contractWrapper,method:"approveCurrencyForListing",args:[listingId,resolvedCurrencyAddress,pricePerTokenInCurrency]});return tx.setGasLimitMultiple(1.2),tx}));revokeCurrencyApprovalForListing=(0,_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.f)((async(listingId,currencyContractAddress)=>{const listing=await this.validateListing(ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(listingId)),resolvedCurrencyAddress=await(0,_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.aL)(currencyContractAddress);if(resolvedCurrencyAddress===listing.currencyContractAddress)throw new Error("Can't revoke approval for main listing currency.");const currencyPrice=await this.contractWrapper.read("currencyPriceForListing",[listingId,resolvedCurrencyAddress]);(0,tiny_invariant__WEBPACK_IMPORTED_MODULE_12__.A)(!currencyPrice.isZero(),"Currency not approved.");const tx=_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.T.fromContractWrapper({contractWrapper:this.contractWrapper,method:"approveCurrencyForListing",args:[listingId,resolvedCurrencyAddress,ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(0)]});return tx.setGasLimitMultiple(1.2),tx}));async validateListing(listingId){try{return await this.getListing(listingId)}catch(err){throw console.error(`Error getting the listing with id ${listingId}`),err}}async mapListing(listing){let status=Status.UNSET;const blockTime=(await this.contractWrapper.getProvider().getBlock("latest")).timestamp;switch(listing.status){case 1:status=ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(listing.startTimestamp).gt(blockTime)?Status.Created:ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(listing.endTimestamp).lt(blockTime)?Status.Expired:Status.Active;break;case 2:status=Status.Completed;break;case 3:status=Status.Cancelled}return{assetContractAddress:listing.assetContract,currencyContractAddress:listing.currency,pricePerToken:listing.pricePerToken.toString(),currencyValuePerToken:await(0,_fetchCurrencyValue_32d08b05_browser_esm_js__WEBPACK_IMPORTED_MODULE_4__.a)(this.contractWrapper.getProvider(),listing.currency,listing.pricePerToken),id:listing.listingId.toString(),tokenId:listing.tokenId.toString(),quantity:listing.quantity.toString(),startTimeInSeconds:ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(listing.startTimestamp).toNumber(),asset:await(0,_QueryParams_32a56510_browser_esm_js__WEBPACK_IMPORTED_MODULE_13__.c)(listing.assetContract,this.contractWrapper.getProvider(),listing.tokenId,this.storage),endTimeInSeconds:ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(listing.endTimestamp).toNumber(),creatorAddress:listing.listingCreator,isReservedListing:listing.reserved,status}}async isStillValidListing(listing,quantity){if(!await(0,_marketplace_e3129e2f_browser_esm_js__WEBPACK_IMPORTED_MODULE_7__.i)(this.contractWrapper.getProvider(),this.getAddress(),listing.assetContractAddress,listing.tokenId,listing.creatorAddress))return{valid:!1,error:`Token '${listing.tokenId}' from contract '${listing.assetContractAddress}' is not approved for transfer`};const provider=this.contractWrapper.getProvider(),ERC165Abi=(await __webpack_require__.e(4811).then(__webpack_require__.t.bind(__webpack_require__,"./node_modules/@thirdweb-dev/contracts-js/dist/abis/IERC165.json",19))).default,erc165=new ethers__WEBPACK_IMPORTED_MODULE_14__.NZ(listing.assetContractAddress,ERC165Abi,provider),isERC721=await erc165.supportsInterface(_QueryParams_32a56510_browser_esm_js__WEBPACK_IMPORTED_MODULE_13__.I),isERC1155=await erc165.supportsInterface(_QueryParams_32a56510_browser_esm_js__WEBPACK_IMPORTED_MODULE_13__.a);if(isERC721){const ERC721Abi=(await Promise.resolve().then(__webpack_require__.t.bind(__webpack_require__,"./node_modules/@thirdweb-dev/contracts-js/dist/abis/IERC721.json",19))).default,asset=new ethers__WEBPACK_IMPORTED_MODULE_14__.NZ(listing.assetContractAddress,ERC721Abi,provider);let owner;try{owner=await asset.ownerOf(listing.tokenId)}catch(e){}const valid=owner?.toLowerCase()===listing.creatorAddress.toLowerCase();return{valid,error:valid?void 0:`Seller is not the owner of Token '${listing.tokenId}' from contract '${listing.assetContractAddress} anymore'`}}if(isERC1155){const ERC1155Abi=(await Promise.resolve().then(__webpack_require__.t.bind(__webpack_require__,"./node_modules/@thirdweb-dev/contracts-js/dist/abis/IERC1155.json",19))).default,asset=new ethers__WEBPACK_IMPORTED_MODULE_14__.NZ(listing.assetContractAddress,ERC1155Abi,provider),valid=(await asset.balanceOf(listing.creatorAddress,listing.tokenId)).gte(quantity||listing.quantity);return{valid,error:valid?void 0:`Seller does not have enough balance of Token '${listing.tokenId}' from contract '${listing.assetContractAddress} to fulfill the listing`}}return{valid:!1,error:"Contract does not implement ERC 1155 or ERC 721."}}async applyFilter(listings,filter){let rawListings=[...listings];if(filter){if(filter.seller){const resolvedSeller=await(0,_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.aL)(filter.seller);rawListings=rawListings.filter((seller=>seller.listingCreator.toString().toLowerCase()===resolvedSeller?.toString().toLowerCase()))}if(filter.tokenContract){const resolvedToken=await(0,_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.aL)(filter.tokenContract);rawListings=rawListings.filter((tokenContract=>tokenContract.assetContract.toString().toLowerCase()===resolvedToken?.toString().toLowerCase()))}void 0!==filter.tokenId&&(rawListings=rawListings.filter((tokenContract=>tokenContract.tokenId.toString()===filter?.tokenId?.toString())))}return filter?.count&&filter.count<rawListings.length?rawListings.slice(0,filter.count):rawListings}}const EnglishAuctionInputParamsSchema=(()=>zod__WEBPACK_IMPORTED_MODULE_0__.z.object({assetContractAddress:_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.b9,tokenId:_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.b6,quantity:_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.b6.default(1),currencyContractAddress:_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.b9.default(_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.aV),minimumBidAmount:_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.cw,buyoutBidAmount:_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.cw,timeBufferInSeconds:_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.b6.default(900),bidBufferBps:_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.b6.default(500),startTimestamp:_assertEnabled_d1700f0b_browser_esm_js__WEBPACK_IMPORTED_MODULE_2__.R.default(new Date),endTimestamp:_assertEnabled_d1700f0b_browser_esm_js__WEBPACK_IMPORTED_MODULE_2__.E}))();class MarketplaceV3EnglishAuctions{featureName=_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.dB.name;constructor(contractWrapper,storage){this.contractWrapper=contractWrapper,this.storage=storage,this.events=new _contract_appuri_5c40af52_browser_esm_js__WEBPACK_IMPORTED_MODULE_3__.a(this.contractWrapper),this.encoder=new _fetchCurrencyValue_32d08b05_browser_esm_js__WEBPACK_IMPORTED_MODULE_4__.C(this.contractWrapper),this.interceptor=new _contract_interceptor_d7b164a7_browser_esm_js__WEBPACK_IMPORTED_MODULE_5__.C(this.contractWrapper),this.estimator=new _contract_appuri_5c40af52_browser_esm_js__WEBPACK_IMPORTED_MODULE_3__.G(this.contractWrapper)}getAddress(){return this.contractWrapper.address}async getTotalCount(){return await this.contractWrapper.read("totalAuctions",[])}async getAll(filter){const totalAuctions=await this.getTotalCount(),start=ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(filter?.start||0).toNumber(),end=totalAuctions.toNumber();if(0===end)throw new Error("No auctions exist on the contract.");let rawAuctions=[];rawAuctions=(await(0,_marketplace_e3129e2f_browser_esm_js__WEBPACK_IMPORTED_MODULE_7__.g)(start,end,((startId,endId)=>this.contractWrapper.read("getAllAuctions",[startId,endId])))).flat();const filteredAuctions=await this.applyFilter(rawAuctions,filter);return await Promise.all(filteredAuctions.map((auction=>this.mapAuction(auction))))}async getAllValid(filter){const totalAuctions=await this.getTotalCount(),start=ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(filter?.start||0).toNumber(),end=totalAuctions.toNumber();if(0===end)throw new Error("No auctions exist on the contract.");let rawAuctions=[];rawAuctions=(await(0,_marketplace_e3129e2f_browser_esm_js__WEBPACK_IMPORTED_MODULE_7__.g)(start,end,((startId,endId)=>this.contractWrapper.read("getAllValidAuctions",[startId,endId])))).flat();const filteredAuctions=await this.applyFilter(rawAuctions,filter);return await Promise.all(filteredAuctions.map((auction=>this.mapAuction(auction))))}async getAuction(auctionId){const auction=await this.contractWrapper.read("getAuction",[auctionId]);return await this.mapAuction(auction)}async getWinningBid(auctionId){await this.validateAuction(ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(auctionId));const bid=await this.contractWrapper.read("getWinningBid",[auctionId]);if(bid._bidder!==ethers__WEBPACK_IMPORTED_MODULE_15__.L)return await this.mapBid(auctionId.toString(),bid._bidder,bid._currency,bid._bidAmount.toString())}async isWinningBid(auctionId,bidAmount){return await this.contractWrapper.read("isNewWinningBid",[auctionId,bidAmount])}async getWinner(auctionId){const auction=await this.validateAuction(ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(auctionId)),bid=await this.contractWrapper.read("getWinningBid",[auctionId]),now=ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(Math.floor(Date.now()/1e3)),endTime=ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(auction.endTimeInSeconds);if(now.gt(endTime)&&bid._bidder!==ethers__WEBPACK_IMPORTED_MODULE_15__.L)return bid._bidder;const contractEvent=new _contract_appuri_5c40af52_browser_esm_js__WEBPACK_IMPORTED_MODULE_3__.a(this.contractWrapper),closed=(await contractEvent.getEvents("AuctionClosed")).find((a=>a.data.auctionId.eq(ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(auctionId))));if(!closed)throw new Error(`Could not find auction with ID ${auctionId} in closed auctions`);return closed.data.winningBidder}createAuction=(0,_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.f)((async auction=>{const parsedAuction=EnglishAuctionInputParamsSchema.parse(auction);await(0,_marketplace_e3129e2f_browser_esm_js__WEBPACK_IMPORTED_MODULE_7__.h)(this.contractWrapper,this.getAddress(),parsedAuction.assetContractAddress,parsedAuction.tokenId,await this.contractWrapper.getSignerAddress());const normalizedBuyoutAmount=await(0,_normalizePriceValue_9851c0eb_browser_esm_js__WEBPACK_IMPORTED_MODULE_9__.n)(this.contractWrapper.getProvider(),parsedAuction.buyoutBidAmount,parsedAuction.currencyContractAddress),normalizedMinBidAmount=await(0,_normalizePriceValue_9851c0eb_browser_esm_js__WEBPACK_IMPORTED_MODULE_9__.n)(this.contractWrapper.getProvider(),parsedAuction.minimumBidAmount,parsedAuction.currencyContractAddress),blockTime=(await this.contractWrapper.getProvider().getBlock("latest")).timestamp;parsedAuction.startTimestamp.lt(blockTime)&&(parsedAuction.startTimestamp=ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(blockTime));const tx=_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.T.fromContractWrapper({contractWrapper:this.contractWrapper,method:"createAuction",args:[{assetContract:parsedAuction.assetContractAddress,tokenId:parsedAuction.tokenId,quantity:parsedAuction.quantity,currency:(0,_cleanCurrencyAddress_ded19cfe_browser_esm_js__WEBPACK_IMPORTED_MODULE_10__.c)(parsedAuction.currencyContractAddress),minimumBidAmount:normalizedMinBidAmount,buyoutBidAmount:normalizedBuyoutAmount,timeBufferInSeconds:parsedAuction.timeBufferInSeconds,bidBufferBps:parsedAuction.bidBufferBps,startTimestamp:parsedAuction.startTimestamp,endTimestamp:parsedAuction.endTimestamp}],parse:receipt=>({id:this.contractWrapper.parseLogs("NewAuction",receipt.logs)[0].args.auctionId,receipt})});return tx.setGasLimitMultiple(1.2),tx}));createAuctionsBatch=(0,_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.f)((async listings=>{const data=(await Promise.all(listings.map((listing=>this.createAuction.prepare(listing))))).map((tx=>tx.encode())),tx=_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.T.fromContractWrapper({contractWrapper:this.contractWrapper,method:"multicall",args:[data],parse:receipt=>this.contractWrapper.parseLogs("NewAuction",receipt?.logs).map((event=>({id:event.args.auctionId,receipt})))});return tx.setGasLimitMultiple(1.2),tx}));buyoutAuction=(0,_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.f)((async auctionId=>{const auction=await this.validateAuction(ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(auctionId)),currencyMetadata=await(0,_fetchCurrencyValue_32d08b05_browser_esm_js__WEBPACK_IMPORTED_MODULE_4__.f)(this.contractWrapper.getProvider(),auction.currencyContractAddress);return this.makeBid.prepare(auctionId,ethers__WEBPACK_IMPORTED_MODULE_16__.formatUnits(auction.buyoutBidAmount,currencyMetadata.decimals))}));makeBid=(0,_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.f)((async(auctionId,bidAmount)=>{const auction=await this.validateAuction(ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(auctionId)),normalizedBidAmount=await(0,_normalizePriceValue_9851c0eb_browser_esm_js__WEBPACK_IMPORTED_MODULE_9__.n)(this.contractWrapper.getProvider(),bidAmount,auction.currencyContractAddress);if(normalizedBidAmount.eq(ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(0)))throw new Error("Cannot make a bid with 0 value");if(ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(auction.buyoutBidAmount).gt(0)&&normalizedBidAmount.gt(auction.buyoutBidAmount))throw new Error("Bid amount must be less than or equal to buyoutBidAmount");if(await this.getWinningBid(auctionId)){const isWinnner=await this.isWinningBid(auctionId,normalizedBidAmount);(0,tiny_invariant__WEBPACK_IMPORTED_MODULE_12__.A)(isWinnner,"Bid price is too low based on the current winning bid and the bid buffer")}else{const tokenPrice=normalizedBidAmount,minimumBidAmount=ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(auction.minimumBidAmount);(0,tiny_invariant__WEBPACK_IMPORTED_MODULE_12__.A)(tokenPrice.gte(minimumBidAmount),"Bid price is too low based on minimum bid amount")}const overrides=await this.contractWrapper.getCallOverrides()||{};await(0,_setErc20Allowance_7f76f677_browser_esm_js__WEBPACK_IMPORTED_MODULE_11__.s)(this.contractWrapper,normalizedBidAmount,auction.currencyContractAddress,overrides);const tx=_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.T.fromContractWrapper({contractWrapper:this.contractWrapper,method:"bidInAuction",overrides,args:[auctionId,normalizedBidAmount]});return tx.setGasLimitMultiple(1.2),tx}));cancelAuction=(0,_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.f)((async auctionId=>{if(await this.getWinningBid(auctionId))throw new Error("Bids already made.");const tx=_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.T.fromContractWrapper({contractWrapper:this.contractWrapper,method:"cancelAuction",args:[auctionId]});return tx.setGasLimitMultiple(1.2),tx}));closeAuctionForBidder=(0,_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.f)((async(auctionId,closeFor)=>{closeFor||(closeFor=await this.contractWrapper.getSignerAddress());const auction=await this.validateAuction(ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(auctionId));try{const tx=_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.T.fromContractWrapper({contractWrapper:this.contractWrapper,method:"collectAuctionTokens",args:[ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(auctionId)]});return tx.setGasLimitMultiple(1.2),tx}catch(err){throw err.message.includes("Marketplace: auction still active.")?new _index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.w(auctionId.toString(),auction.endTimeInSeconds.toString()):err}}));closeAuctionForSeller=(0,_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.f)((async auctionId=>{const auction=await this.validateAuction(ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(auctionId));try{const tx=_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.T.fromContractWrapper({contractWrapper:this.contractWrapper,method:"collectAuctionPayout",args:[ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(auctionId)]});return tx.setGasLimitMultiple(1.2),tx}catch(err){throw err.message.includes("Marketplace: auction still active.")?new _index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.w(auctionId.toString(),auction.endTimeInSeconds.toString()):err}}));executeSale=(0,_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.f)((async auctionId=>{const auction=await this.validateAuction(ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(auctionId));try{const winningBid=await this.getWinningBid(auctionId);(0,tiny_invariant__WEBPACK_IMPORTED_MODULE_12__.A)(winningBid,"No winning bid found");const closeForSeller=this.encoder.encode("collectAuctionPayout",[auctionId]),closeForBuyer=this.encoder.encode("collectAuctionTokens",[auctionId]),tx=_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.T.fromContractWrapper({contractWrapper:this.contractWrapper,method:"multicall",args:[[closeForSeller,closeForBuyer]]});return tx.setGasLimitMultiple(1.2),tx}catch(err){throw err.message.includes("Marketplace: auction still active.")?new _index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.w(auctionId.toString(),auction.endTimeInSeconds.toString()):err}}));async getBidBufferBps(auctionId){return(await this.getAuction(auctionId)).bidBufferBps}async getMinimumNextBid(auctionId){const[currentBidBufferBps,winningBid,auction]=await Promise.all([this.getBidBufferBps(auctionId),this.getWinningBid(auctionId),this.validateAuction(ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(auctionId))]),currentBidOrReservePrice=winningBid?ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(winningBid.bidAmount):ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(auction.minimumBidAmount),minimumNextBid=currentBidOrReservePrice.add(currentBidOrReservePrice.mul(currentBidBufferBps).div(1e4));return(0,_fetchCurrencyValue_32d08b05_browser_esm_js__WEBPACK_IMPORTED_MODULE_4__.a)(this.contractWrapper.getProvider(),auction.currencyContractAddress,minimumNextBid)}async validateAuction(auctionId){try{return await this.getAuction(auctionId)}catch(err){throw console.error(`Error getting the auction with id ${auctionId}`),err}}async mapAuction(auction){let status=Status.UNSET;const blockTime=(await this.contractWrapper.getProvider().getBlock("latest")).timestamp;switch(auction.status){case 1:status=ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(auction.startTimestamp).gt(blockTime)?Status.Created:ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(auction.endTimestamp).lt(blockTime)?Status.Expired:Status.Active;break;case 2:status=Status.Completed;break;case 3:status=Status.Cancelled}return{id:auction.auctionId.toString(),creatorAddress:auction.auctionCreator,assetContractAddress:auction.assetContract,tokenId:auction.tokenId.toString(),quantity:auction.quantity.toString(),currencyContractAddress:auction.currency,minimumBidAmount:auction.minimumBidAmount.toString(),minimumBidCurrencyValue:await(0,_fetchCurrencyValue_32d08b05_browser_esm_js__WEBPACK_IMPORTED_MODULE_4__.a)(this.contractWrapper.getProvider(),auction.currency,auction.minimumBidAmount),buyoutBidAmount:auction.buyoutBidAmount.toString(),buyoutCurrencyValue:await(0,_fetchCurrencyValue_32d08b05_browser_esm_js__WEBPACK_IMPORTED_MODULE_4__.a)(this.contractWrapper.getProvider(),auction.currency,auction.buyoutBidAmount),timeBufferInSeconds:ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(auction.timeBufferInSeconds).toNumber(),bidBufferBps:ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(auction.bidBufferBps).toNumber(),startTimeInSeconds:ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(auction.startTimestamp).toNumber(),endTimeInSeconds:ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(auction.endTimestamp).toNumber(),asset:await(0,_QueryParams_32a56510_browser_esm_js__WEBPACK_IMPORTED_MODULE_13__.c)(auction.assetContract,this.contractWrapper.getProvider(),auction.tokenId,this.storage),status}}async mapBid(auctionId,bidderAddress,currencyContractAddress,bidAmount){const resolvedBidderAddress=await(0,_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.aL)(bidderAddress),resolvedCurrencyAddress=await(0,_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.aL)(currencyContractAddress);return{auctionId,bidderAddress:resolvedBidderAddress,currencyContractAddress:resolvedCurrencyAddress,bidAmount,bidAmountCurrencyValue:await(0,_fetchCurrencyValue_32d08b05_browser_esm_js__WEBPACK_IMPORTED_MODULE_4__.a)(this.contractWrapper.getProvider(),resolvedCurrencyAddress,bidAmount)}}async applyFilter(auctions,filter){let rawAuctions=[...auctions];if(filter){if(filter.seller){const resolvedSeller=await(0,_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.aL)(filter.seller);rawAuctions=rawAuctions.filter((seller=>seller.auctionCreator.toString().toLowerCase()===resolvedSeller?.toString().toLowerCase()))}if(filter.tokenContract){const resolvedToken=await(0,_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.aL)(filter.tokenContract);rawAuctions=rawAuctions.filter((tokenContract=>tokenContract.assetContract.toString().toLowerCase()===resolvedToken?.toString().toLowerCase()))}void 0!==filter.tokenId&&(rawAuctions=rawAuctions.filter((tokenContract=>tokenContract.tokenId.toString()===filter?.tokenId?.toString())))}return filter?.count&&filter.count<rawAuctions.length?rawAuctions.slice(0,filter.count):rawAuctions}}const OfferInputParamsSchema=(()=>zod__WEBPACK_IMPORTED_MODULE_0__.z.object({assetContractAddress:_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.b9,tokenId:_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.b6,quantity:_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.b6.default(1),currencyContractAddress:_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.b9.default(_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.aV),totalPrice:_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.cw,endTimestamp:_assertEnabled_d1700f0b_browser_esm_js__WEBPACK_IMPORTED_MODULE_2__.E}))();class MarketplaceV3Offers{featureName=_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.dC.name;constructor(contractWrapper,storage){this.contractWrapper=contractWrapper,this.storage=storage,this.events=new _contract_appuri_5c40af52_browser_esm_js__WEBPACK_IMPORTED_MODULE_3__.a(this.contractWrapper),this.encoder=new _fetchCurrencyValue_32d08b05_browser_esm_js__WEBPACK_IMPORTED_MODULE_4__.C(this.contractWrapper),this.interceptor=new _contract_interceptor_d7b164a7_browser_esm_js__WEBPACK_IMPORTED_MODULE_5__.C(this.contractWrapper),this.estimator=new _contract_appuri_5c40af52_browser_esm_js__WEBPACK_IMPORTED_MODULE_3__.G(this.contractWrapper)}getAddress(){return this.contractWrapper.address}async getTotalCount(){return await this.contractWrapper.read("totalOffers",[])}async getAll(filter){const totalOffers=await this.getTotalCount(),start=ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(filter?.start||0).toNumber(),end=totalOffers.toNumber();if(0===end)throw new Error("No offers exist on the contract.");let rawOffers=[];rawOffers=(await(0,_marketplace_e3129e2f_browser_esm_js__WEBPACK_IMPORTED_MODULE_7__.g)(start,end,((startId,endId)=>this.contractWrapper.read("getAllOffers",[startId,endId])))).flat();const filteredOffers=await this.applyFilter(rawOffers,filter);return await Promise.all(filteredOffers.map((offer=>this.mapOffer(offer))))}async getAllValid(filter){const totalOffers=await this.getTotalCount(),start=ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(filter?.start||0).toNumber(),end=totalOffers.toNumber();if(0===end)throw new Error("No offers exist on the contract.");let rawOffers=[];rawOffers=(await(0,_marketplace_e3129e2f_browser_esm_js__WEBPACK_IMPORTED_MODULE_7__.g)(start,end,((startId,endId)=>this.contractWrapper.read("getAllValidOffers",[startId,endId])))).flat();const filteredOffers=await this.applyFilter(rawOffers,filter);return await Promise.all(filteredOffers.map((offer=>this.mapOffer(offer))))}async getOffer(offerId){const offer=await this.contractWrapper.read("getOffer",[offerId]);return await this.mapOffer(offer)}makeOffer=(0,_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.f)((async offer=>{const parsedOffer=await OfferInputParamsSchema.parseAsync(offer),chainId=await this.contractWrapper.getChainID(),currency=(0,_fetchCurrencyValue_32d08b05_browser_esm_js__WEBPACK_IMPORTED_MODULE_4__.i)(parsedOffer.currencyContractAddress)?_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.aW[chainId].wrapped.address:parsedOffer.currencyContractAddress,normalizedTotalPrice=await(0,_normalizePriceValue_9851c0eb_browser_esm_js__WEBPACK_IMPORTED_MODULE_9__.n)(this.contractWrapper.getProvider(),parsedOffer.totalPrice,currency),overrides=await this.contractWrapper.getCallOverrides();return await(0,_setErc20Allowance_7f76f677_browser_esm_js__WEBPACK_IMPORTED_MODULE_11__.s)(this.contractWrapper,normalizedTotalPrice,currency,overrides),_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.T.fromContractWrapper({contractWrapper:this.contractWrapper,method:"makeOffer",args:[{assetContract:parsedOffer.assetContractAddress,tokenId:parsedOffer.tokenId,quantity:parsedOffer.quantity,currency,totalPrice:normalizedTotalPrice,expirationTimestamp:parsedOffer.endTimestamp}],parse:receipt=>({id:this.contractWrapper.parseLogs("NewOffer",receipt?.logs)[0].args.offerId,receipt})})}));cancelOffer=(0,_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.f)((async offerId=>_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.T.fromContractWrapper({contractWrapper:this.contractWrapper,method:"cancelOffer",args:[offerId]})));acceptOffer=(0,_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.f)((async offerId=>{const offer=await this.validateOffer(ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(offerId)),{valid,error}=await this.isStillValidOffer(offer);if(!valid)throw new Error(`Offer ${offerId} is no longer valid. ${error}`);const overrides=await this.contractWrapper.getCallOverrides()||{};return await(0,_marketplace_e3129e2f_browser_esm_js__WEBPACK_IMPORTED_MODULE_7__.h)(this.contractWrapper,this.getAddress(),offer.assetContractAddress,offer.tokenId,await this.contractWrapper.getSignerAddress()),_transactions_72f9603c_browser_esm_js__WEBPACK_IMPORTED_MODULE_8__.T.fromContractWrapper({contractWrapper:this.contractWrapper,method:"acceptOffer",args:[offerId],overrides})}));async validateOffer(offerId){try{return await this.getOffer(offerId)}catch(err){throw console.error(`Error getting the offer with id ${offerId}`),err}}async mapOffer(offer){let status=Status.UNSET;const blockTime=(await this.contractWrapper.getProvider().getBlock("latest")).timestamp;switch(offer.status){case 1:status=ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(offer.expirationTimestamp).lt(blockTime)?Status.Expired:Status.Active;break;case 2:status=Status.Completed;break;case 3:status=Status.Cancelled}return{id:offer.offerId.toString(),offerorAddress:offer.offeror,assetContractAddress:offer.assetContract,currencyContractAddress:offer.currency,tokenId:offer.tokenId.toString(),quantity:offer.quantity.toString(),totalPrice:offer.totalPrice.toString(),currencyValue:await(0,_fetchCurrencyValue_32d08b05_browser_esm_js__WEBPACK_IMPORTED_MODULE_4__.a)(this.contractWrapper.getProvider(),offer.currency,offer.totalPrice),asset:await(0,_QueryParams_32a56510_browser_esm_js__WEBPACK_IMPORTED_MODULE_13__.c)(offer.assetContract,this.contractWrapper.getProvider(),offer.tokenId,this.storage),endTimeInSeconds:ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(offer.expirationTimestamp).toNumber(),status}}async isStillValidOffer(offer){if(ethers__WEBPACK_IMPORTED_MODULE_6__.gH.from(Math.floor(Date.now()/1e3)).gt(offer.endTimeInSeconds))return{valid:!1,error:`Offer with ID ${offer.id} has expired`};const chainId=await this.contractWrapper.getChainID(),currency=(0,_fetchCurrencyValue_32d08b05_browser_esm_js__WEBPACK_IMPORTED_MODULE_4__.i)(offer.currencyContractAddress)?_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.aW[chainId].wrapped.address:offer.currencyContractAddress,provider=this.contractWrapper.getProvider(),ERC20Abi=(await Promise.resolve().then(__webpack_require__.t.bind(__webpack_require__,"./node_modules/@thirdweb-dev/contracts-js/dist/abis/IERC20.json",19))).default,erc20=new _index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.cs(provider,currency,ERC20Abi,{},this.storage);if((await erc20.read("balanceOf",[offer.offerorAddress])).lt(offer.totalPrice))return{valid:!1,error:`Offeror ${offer.offerorAddress} doesn't have enough balance of token ${currency}`};return(await erc20.read("allowance",[offer.offerorAddress,this.getAddress()])).lt(offer.totalPrice)?{valid:!1,error:`Offeror ${offer.offerorAddress} hasn't approved enough amount of token ${currency}`}:{valid:!0,error:""}}async applyFilter(offers,filter){let rawOffers=[...offers];if(filter){if(filter.offeror){const resolvedOfferor=await(0,_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.aL)(filter.offeror);rawOffers=rawOffers.filter((offeror=>offeror.offeror.toString().toLowerCase()===resolvedOfferor?.toString().toLowerCase()))}if(filter.tokenContract){const resolvedToken=await(0,_index_33cd3415_browser_esm_js__WEBPACK_IMPORTED_MODULE_1__.aL)(filter.tokenContract);rawOffers=rawOffers.filter((tokenContract=>tokenContract.assetContract.toString().toLowerCase()===resolvedToken?.toString().toLowerCase()))}void 0!==filter.tokenId&&(rawOffers=rawOffers.filter((tokenContract=>tokenContract.tokenId.toString()===filter?.tokenId?.toString())))}return filter?.count&&filter.count<rawOffers.length?rawOffers.slice(0,filter.count):rawOffers}}}}]);